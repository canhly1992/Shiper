<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHIẾU THU TIỀN PHÒNG</title>
  <style>
    @page { size: A4 portrait; margin: 8mm; }
    body{
      font-family: "Times New Roman", serif;
      font-size: 12px;
      color:#000;
      margin:0; padding:0;
    }
    .wrap{ width:820px; margin:12px auto; padding:12px; border:1px solid #111; }
    .center{text-align:center}
    h1{font-size:18px;margin:6px 0}
    .header{display:flex;justify-content:space-between;align-items:flex-start}
    .company{width:60%}
    .meta{width:35%;text-align:right}
    .meta p{margin:2px 0}
    .info{margin-top:8px; display:flex; gap:10px;}
    .info .col{width:50%}
    .info p{margin:2px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    table, th, td{border:1px solid #000}
    th, td{padding:6px 4px; text-align:center; font-size:12px}
    th:first-child, td:first-child{ text-align:left }
    .small{font-size:11px}
    .right{text-align:right}
    .no-border{border:0}
    .totals{width:100%;margin-top:10px}
    .totals td{padding:4px}
    .sign{display:flex;justify-content:space-between;margin-top:18px}
    .sign .col{width:45%;text-align:center}
    .highlight{font-weight:bold}
    .warning{background:yellow;color:red;padding:2px}
    .qr{margin-top:8px;text-align:center}
    @media print{
      .wrap{border:0}
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="header">
      <div class="company">
        <div class="center"><h1>PHIẾU THU TIỀN PHÒNG</h1></div>
        <p class="small">Địa chỉ: 122 Nơ Trang Long, Bình Thạnh, TP HCM</p>
        <p class="small">Liên hệ: 0866.162.134 (Zalo/WhatsApp)</p>
      </div>
      <div class="meta">
        <p><strong>Thời gian:</strong> <span id="thoigian-ngay">-</span></p>
        <p><strong>Số điện thoại:</strong> <span id="sdt">-</span></p>
        <p><strong>Số TK:</strong> <span id="sotaikhoan">-</span></p>
        <p><strong>Kỳ thanh toán:</strong> <span id="maso">-</span></p>
      </div>
    </div>

    <div class="info">
      <div class="col">
        <p><strong>Mã phòng / Tên KH:</strong> <span id="hoten">-</span></p>
        <p><strong>Địa chỉ:</strong> <span id="diachi">-</span></p>
        <p><strong>Ghi chú:</strong> <span id="ghichu">-</span></p>
      </div>
      <div class="col">
        <p><strong>Tên tài khoản:</strong> <span id="tentaikhoan">-</span></p>
        <p><strong>Ngân hàng:</strong> <span id="nganhang">-</span></p>
        <p><strong>Sale / Người thu:</strong> <span id="bacsi">-</span></p>
      </div>
    </div>

    <!-- Dịch vụ khác -->
    <table>
      <thead>
        <tr>
          <th>Dịch vụ</th>
          <th>SL</th>
          <th>Đơn giá</th>
          <th>Chiết khấu</th>
          <th>Thành tiền</th>
          <th>Ghi chú</th>
        </tr>
      </thead>
      <tbody id="services-body">
        <!-- rows injected -->
      </tbody>
    </table>

    <!-- Điện -->
    <table>
      <thead>
        <tr>
          <th colspan="6">Tiền Điện</th>
        </tr>
        <tr>
          <th>Dịch vụ</th>
          <th>Chỉ số cũ</th>
          <th>Chỉ số mới</th>
          <th>Số lượng (kWh)</th>
          <th>Đơn giá</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody id="dien-body">
      </tbody>
    </table>

    <!-- Nước -->
    <table>
      <thead>
        <tr>
          <th colspan="6">Tiền Nước</th>
        </tr>
        <tr>
          <th>Dịch vụ</th>
          <th>Chỉ số cũ</th>
          <th>Chỉ số mới</th>
          <th>Số lượng (m³)</th>
          <th>Đơn giá</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody id="nuoc-body">
      </tbody>
    </table>

    <table class="totals">
      <tr>
        <td class="no-border" style="width:70%">
          <div class="small">Thông tin chuyển khoản:</div>
          <div class="small">Chủ tài khoản: <span id="tentaikhoan2">-</span></div>
          <div class="small">Số tài khoản: <span id="sotaikhoan2">-</span></div>
          <div class="small">Ngân hàng: <span id="nganhang2">-</span></div>
          <div class="small">Nội dung CK: <span id="noidungck">-</span></div>
          <div class="small warning">Lưu ý: Vui lòng nhập đúng nội dung CK. Sai nội dung = chưa thanh toán.</div>
        </td>
        <td style="vertical-align:top">
          <table style="width:100%">
            <tr>
              <td class="right">Tổng cộng:</td>
              <td id="total-display" class="right">0 đ</td>
            </tr>
            <tr>
              <td class="right">Giảm giá:</td>
              <td id="discount-display" class="right">0 đ</td>
            </tr>
            <tr>
              <td class="right highlight">Còn lại:</td>
              <td id="due-display" class="right highlight">0 đ</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>

    <div class="qr" id="qr-wrap"></div>

    <div class="sign">
      <div class="col small">Ngày <span id="ngay">-</span><br><strong>Người lập phiếu</strong></div>
      <div class="col small">&nbsp;<br><strong>Người nhận tiền</strong></div>
    </div>
  </div>

  <script>
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || "";
    }

    function nTo(num){
      if(!num && num !== 0) return 0;
      return Number(String(num).replace(/[^\d\-\.]/g, "")) || 0;
    }

    function formatVND(num){
      return Number(num).toLocaleString('vi-VN') + ' đ';
    }

    function build(){
      // basic fields
      document.getElementById('hoten').innerText = decodeURIComponent(getParam('hoten')) || getParam('maso') || '-';
      document.getElementById('diachi').innerText = decodeURIComponent(getParam('diachi')) || '-';
      document.getElementById('ghichu').innerText = decodeURIComponent(getParam('ghichu')) || '-';
      document.getElementById('sdt').innerText = decodeURIComponent(getParam('sdt')) || '-';
      document.getElementById('maso').innerText = getParam('maso') || '-';

      document.getElementById('sotaikhoan').innerText = getParam('sotaikhoan') || '-';
      document.getElementById('tentaikhoan').innerText = decodeURIComponent(getParam('tentaikhoan')) || '-';
      document.getElementById('tentaikhoan2').innerText = decodeURIComponent(getParam('tentaikhoan')) || '-';
      document.getElementById('nganhang').innerText = decodeURIComponent(getParam('nganhang')) || '-';
      document.getElementById('nganhang2').innerText = decodeURIComponent(getParam('nganhang')) || '-';

      // date
      const nowVN = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Ho_Chi_Minh'}));
      const d = String(nowVN.getDate()).padStart(2,'0');
      const m = String(nowVN.getMonth()+1).padStart(2,'0');
      const y = nowVN.getFullYear();
      document.getElementById('thoigian-ngay').innerText = d + '/' + m + '/' + y;
      document.getElementById('ngay').innerText = d + '/' + m + '/' + y;

      // services: we expect individual fields
      const tieninternet = nTo(getParam('tieninternet'));
      const rac = nTo(getParam('rac'));
      const soluongxe = getParam('soluongxe') ? getParam('soluongxe') : '';
      const phixe = nTo(getParam('phixe'));
      const tongphixe = nTo(getParam('tongphixe')) || (nTo(soluongxe) * nTo(phixe));
      const chiphipkhac = nTo(getParam('chiphipkhac'));

      const services = [];
      if(tieninternet) services.push({name:'Internet', sl:1, price:tieninternet, disc:'0%', total:tieninternet, note:''});
      if(rac) services.push({name:'Phí rác', sl:1, price:rac, disc:'0%', total:rac, note:''});
      if(soluongxe || phixe || tongphixe) services.push({name:'Gửi xe', sl: (soluongxe||1), price: phixe, disc:'0%', total: tongphixe, note: ''});
      if(chiphipkhac) services.push({name:'Chi phí khác', sl:1, price:chiphipkhac, disc:'0%', total:chiphipkhac, note:''});

      // populate services table
      const sb = document.getElementById('services-body');
      sb.innerHTML = '';
      let sumServices = 0;
      if(services.length === 0){
        sb.innerHTML = '<tr><td class="left" colspan="6">(Không có dịch vụ khác)</td></tr>';
      } else {
        services.forEach(s => {
          sumServices += Number(s.total || 0);
          sb.insertAdjacentHTML('beforeend', `<tr>
            <td class="left">${s.name}</td>
            <td>${s.sl}</td>
            <td class="right">${formatVND(s.price)}</td>
            <td>${s.disc}</td>
            <td class="right">${formatVND(s.total)}</td>
            <td class="left">${s.note||''}</td>
          </tr>`);
        });
      }

      // dien
      const sodiencu = nTo(getParam('sodiencu'));
      const sodienmoi = nTo(getParam('sodienmoi'));
      const giadien = nTo(getParam('giadien'));
      const tongtiendien_param = nTo(getParam('tongtiendien'));
      const dienthanhtien = (sodienmoi && sodiencu) ? (sodienmoi - sodiencu) * giadien : tongtiendien_param;
      const dienBody = document.getElementById('dien-body');
      dienBody.innerHTML = '';
      if(dienthanhtien){
        dienBody.innerHTML = `<tr>
          <td class="left">Điện</td>
          <td class="right">${sodiencu || ''}</td>
          <td class="right">${sodienmoi || ''}</td>
          <td class="right">${(sodienmoi && sodiencu) ? (sodienmoi - sodiencu) : ''}</td>
          <td class="right">${formatVND(giadien)}</td>
          <td class="right">${formatVND(dienthanhtien)}</td>
        </tr>`;
      } else {
        dienBody.innerHTML = '<tr><td class="left" colspan="6">(Không có thông tin điện)</td></tr>';
      }

      // nuoc
      const sonuoccu = nTo(getParam('sonuoccu'));
      const sonuocmoi = nTo(getParam('sonuocmoi'));
      const gianuoc = nTo(getParam('gianuoc'));
      const tongtiennuoc_param = nTo(getParam('tongtiennuoc'));
      const nuocthanhtien = (sonuocmoi && sonuoccu) ? (sonuocmoi - sonuoccu) * gianuoc : tongtiennuoc_param;
      const nuocBody = document.getElementById('nuoc-body');
      nuocBody.innerHTML = '';
      if(nuocthanhtien){
        nuocBody.innerHTML = `<tr>
          <td class="left">Nước</td>
          <td class="right">${sonuoccu || ''}</td>
          <td class="right">${sonuocmoi || ''}</td>
          <td class="right">${(sonuocmoi && sonuoccu) ? (sonuocmoi - sonuoccu) : ''}</td>
          <td class="right">${formatVND(gianuoc)}</td>
          <td class="right">${formatVND(nuocthanhtien)}</td>
        </tr>`;
      } else {
        nuocBody.innerHTML = '<tr><td class="left" colspan="6">(Không có thông tin nước)</td></tr>';
      }

      // totals: allow either computed or passed
      const tongtienphong = nTo(getParam('tongtienphong'));
      const totalPassed = nTo(getParam('tongtien'));
      const discount = nTo(getParam('giagiam'));
      const conlai_pass = nTo(getParam('conlai'));

      // compute total: sum of (room + services + dien + nuoc) if available, else use passed total
      const room = tongtienphong || 0;
      const dien = dienthanhtien || 0;
      const nuoc = nuocthanhtien || 0;
      const servicesSum = sumServices || 0;
      const computedTotal = room + dien + nuoc + servicesSum;
      const totalFinal = totalPassed || computedTotal;
      const due = (conlai_pass) ? conlai_pass : (totalFinal - nTo(getParam('dathanhtoan')));

      document.getElementById('total-display').innerText = formatVND(totalFinal);
      document.getElementById('discount-display').innerText = formatVND(discount);
      document.getElementById('due-display').innerText = formatVND(due);

      document.getElementById('noidungck').innerText = getParam('noidungck') || ('TT BILL');

      // QR code (simple): generate a payment text QR via Google Chart API with content = chuyển khoản info
      const qText = encodeURIComponent(`Thanh toán ${formatVND(due)} - ${decodeURIComponent(getParam('hoten')||'Khách')} - TK:${getParam('sotaikhoan')||''}`);
      const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=160x160&chl=${qText}&choe=UTF-8`;
      const qrWrap = document.getElementById('qr-wrap');
      qrWrap.innerHTML = `<img src="${qrUrl}" alt="QR"/>`;

    }

    build();
    // auto print & close
    setTimeout(()=>window.print(),2000);
    //setTimeout(()=>window.close(),5000);
  </script>
</body>
</html>
