<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phiếu thu tiền phòng | Rental Invoice</title>
  <style>
    /* Reset cơ bản */
    * { box-sizing: border-box; margin:0; padding:0; }

    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      line-height: 1.3;
      color: #000;
      background: #fff;
      padding: 0;
    }

    .invoice-box {
      width: 190mm; /* nhỏ hơn 210mm của A4 */
      margin: 5mm auto;
      padding: 10mm;
      border: 1px solid #000;
    }

    h2, h3 { text-align: center; margin: 4px 0; }
    h2 small, h3 small { display: block; font-size: 10px; }

    .sub-header { text-align: center; font-size: 11px; margin-bottom: 6px; }
    p { margin: 2px 0; }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px 10px;
      margin-top: 6px;
      font-size: 11px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    table, th, td { border: 1px solid #000; }
    th, td { padding: 4px; text-align: center; }

    .summary { margin-top: 6px; text-align: right; font-size: 11px; }

    .footer {
      margin-top: 10mm;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }

    .footer .sign { text-align: center; width: 180px; }

    .ck-table { width:100%; border-collapse:collapse; margin-top:6px; font-size:11px; }
    .ck-table td { border:1px solid #000; padding:4px; }
    .ck-table td.label { width:28%; font-weight:600; background:#f7f7f7; text-align:left; }

    .ck-note { color:red; font-size:10px; margin-top:4px; }

    @media print {
      body { margin:0; padding:0; }
      .invoice-box { width: 190mm; padding: 5mm; border: none; }
      table, th, td { border:1px solid #000; }
    }
  </style>
</head>
<body>
  <div class="invoice-box">
    <h2>PHIẾU THU TIỀN PHÒNG<br><small>RENTAL INVOICE</small></h2>
    <p class="sub-header">Địa chỉ (Address): <span id="diachi"></span></p>
    <p class="sub-header">Liên hệ (Contact): <span id="sdtchothue"></span> (Zalo/WhatsApp)</p>

    <div class="info-grid">
      <p><strong>Mã phiếu (Invoice No):</strong> <span id="maphieu"></span></p>
      <p><strong>Ngày lập (Date):</strong> <span id="ngaylap"></span></p>
      <p><strong>Mã phòng (Room No):</strong> <span id="maso"></span></p>
      <p><strong>Họ tên (Tenant):</strong> <span id="hoten"></span></p>
      <p><strong>Kỳ thanh toán (Billing Period):</strong> <span id="kythanhtoan"></span></p>
      <p><strong>CCCD/Passport:</strong> <span id="cccd"></span></p>
      <p><strong>SĐT khách thuê (Tenant Phone):</strong> <span id="sdt"></span></p>
    </div>

    <h3>CÁC DỊCH VỤ KHÁC<br><small>OTHER SERVICES</small></h3>
    <table id="services-table">
      <tr>
        <th>Dịch vụ<br><small>Service</small></th>
        <th>Số lượng<br><small>Quantity</small></th>
        <th>Đơn giá<br><small>Unit Price</small></th>
        <th>Thành tiền<br><small>Amount</small></th>
      </tr>
      <tr id="row_tongtienphong"><td>Tổng tiền phòng<br><small>Room Fee</small></td><td>1</td><td id="tongtienphong_unit">0</td><td id="tongtienphong_total">0</td></tr>
      <tr id="row_internet"><td>Internet</td><td>1</td><td id="tieninternet">0</td><td id="thanhtieninternet">0</td></tr>
      <tr id="row_rac"><td>Phí rác<br><small>Garbage</small></td><td>1</td><td id="rac">0</td><td id="thanhtienrac">0</td></tr>
      <tr id="row_xe"><td>Gửi xe<br><small>Parking</small></td><td id="soluongxe">0</td><td id="phixe">0</td><td id="tongphixe">0</td></tr>
      <tr id="row_khac"><td>Chi phí khác<br><small>Other</small></td><td>1</td><td id="chiphipkhac">0</td><td id="thanhtienkhac">0</td></tr>
    </table>

    <h3>TIỀN ĐIỆN & NƯỚC<br><small>ELECTRICITY & WATER</small></h3>
    <table>
      <tr>
        <th>Dịch vụ<br><small>Service</small></th>
        <th>Chỉ số cũ<br><small>Previous</small></th>
        <th>Chỉ số mới<br><small>Current</small></th>
        <th>Số lượng<br><small>Usage</small></th>
        <th>Đơn giá<br><small>Unit Price</small></th>
        <th>Thành tiền<br><small>Amount</small></th>
      </tr>
      <tr>
        <td>Điện (kWh)<br><small>Electricity</small></td>
        <td id="sodiencu"></td>
        <td id="sodienmoi"></td>
        <td id="sodienluong"></td>
        <td id="giadien"></td>
        <td id="tongtiendien"></td>
      </tr>
      <tr>
        <td>Nước (m³)<br><small>Water</small></td>
        <td id="sonuoccu"></td>
        <td id="sonuocmoi"></td>
        <td id="sonuocluong"></td>
        <td id="gianuoc"></td>
        <td id="tongtiennuoc"></td>
      </tr>
    </table>

    <div class="summary">
      <p><strong>Tổng cộng (Total):</strong> <span id="tongtien"></span> VND</p>
      <p><strong>Giảm giá (Discount):</strong> <span id="giagiam"></span> VND</p>
      <p><strong>Còn lại (Balance):</strong> <span id="conlai"></span> VND</p>
    </div>

    <h3>THÔNG TIN CHUYỂN KHOẢN<br><small>BANK TRANSFER INFORMATION</small></h3>
    <table class="ck-table">
      <tr>
        <td class="label">Chủ tài khoản<br><small>Account Holder</small></td>
        <td id="tentaikhoan"></td>
        <td rowspan="4" style="text-align:center; width:200px;">
          <img id="vietqr" src="" alt="QR Thanh toán" width="200" height="200">
        </td>
      </tr>
      <tr>
        <td class="label">Số tài khoản<br><small>Account Number</small></td>
        <td id="sotaikhoan"></td>
      </tr>
      <tr>
        <td class="label">Ngân hàng<br><small>Bank</small></td>
        <td id="nganhang"></td>
      </tr>
      <tr>
        <td class="label">Nội dung CK<br><small>Transfer Note</small></td>
        <td id="noidungck"></td>
      </tr>
    </table>
    <p class="ck-note"><em>Lưu ý (Note): Vui lòng nhập đúng <strong>Nội dung CK / Transfer Note</strong>. Sai nội dung = chưa thanh toán (Wrong note = unpaid).</em></p>

    <div class="footer">
      <div></div>
      <div class="sign">
        <p>Ngày (Date): <span id="ngaylap2"></span></p>
        <p><em>Người lập phiếu<br><small>Issuer</small></em></p>
        <br><br>
        <p><strong>Vũ Cao Long</strong></p>
      </div>
    </div>
  </div>

  <!-- JS giữ nguyên từ bản cũ -->
  <script>
    function getParam(param){ return new URLSearchParams(window.location.search).get(param) || ""; }
    function formatNumber(num){ const n=Number(num)||0; return n.toLocaleString('vi-VN'); }

    document.getElementById("diachi").innerText=getParam("diachi");
    document.getElementById("sdtchothue").innerText=getParam("sdtchothue");
    const ngaylap=getParam("ngaylap"); 
    document.getElementById("ngaylap").innerText=ngaylap; 
    document.getElementById("ngaylap2").innerText=ngaylap;
    ["maphieu","maso","hoten","cccd","sdt","kythanhtoan"].forEach(id=>{
      if(document.getElementById(id)) document.getElementById(id).innerText=getParam(id);
    });

    const tongtienphong=Number(getParam("tienphong"))||0;
    document.getElementById("tongtienphong_unit").innerText=formatNumber(tongtienphong);
    document.getElementById("tongtienphong_total").innerText=formatNumber(tongtienphong);

    const tieninternet=Number(getParam("tieninternet"))||0;
    document.getElementById("tieninternet").innerText=formatNumber(tieninternet);
    document.getElementById("thanhtieninternet").innerText=formatNumber(tieninternet);
    const rac=Number(getParam("rac"))||0;
    document.getElementById("rac").innerText=formatNumber(rac);
    document.getElementById("thanhtienrac").innerText=formatNumber(rac);
    const soluongxe=Number(getParam("soluongxe"))||0;
    const phixe=Number(getParam("phixe"))||0;
    document.getElementById("soluongxe").innerText=soluongxe;
    document.getElementById("phixe").innerText=formatNumber(phixe);
    document.getElementById("tongphixe").innerText=formatNumber(soluongxe*phixe);
    const chiphipkhac=Number(getParam("chiphipkhac"))||0;
    document.getElementById("chiphipkhac").innerText=formatNumber(chiphipkhac);
    document.getElementById("thanhtienkhac").innerText=formatNumber(chiphipkhac);

    [["row_tongtienphong","tongtienphong_total"],["row_internet","thanhtieninternet"],["row_rac","thanhtienrac"],["row_xe","tongphixe"],["row_khac","thanhtienkhac"]].forEach(([rowId,cellId])=>{
      if(Number(document.getElementById(cellId).innerText.replace(/\./g,""))===0){
        document.getElementById(rowId).style.display="none";
      }
    });

    const diencu=Number(getParam("sodiencu"))||0, dienmoi=Number(getParam("sodienmoi"))||0, giadien=Number(getParam("giadien"))||0;
    const sodienluong=Math.max(0,dienmoi-diencu);
    document.getElementById("sodiencu").innerText=diencu;
    document.getElementById("sodienmoi").innerText=dienmoi;
    document.getElementById("sodienluong").innerText=sodienluong;
    document.getElementById("giadien").innerText=formatNumber(giadien);
    document.getElementById("tongtiendien").innerText=formatNumber(sodienluong*giadien);

    const nuoccu=Number(getParam("sonuoccu"))||0, nuocmoi=Number(getParam("sonuocmoi"))||0, gianuoc=Number(getParam("gianuoc"))||0;
    const sonuocluong=Math.max(0,nuocmoi-nuoccu);
    document.getElementById("sonuoccu").innerText=nuoccu;
    document.getElementById("sonuocmoi").innerText=nuocmoi;
    document.getElementById("sonuocluong").innerText=sonuocluong;
    document.getElementById("gianuoc").innerText=formatNumber(gianuoc);
    document.getElementById("tongtiennuoc").innerText=formatNumber(sonuocluong*gianuoc);

    const tongtien=tongtienphong+tieninternet+rac+(soluongxe*phixe)+chiphipkhac+(sodienluong*giadien)+(sonuocluong*gianuoc);
    document.getElementById("tongtien").innerText=formatNumber(tongtien);
    const giagiam=Number(getParam("giagiam"))||0, conlai=tongtien-giagiam;
    document.getElementById("giagiam").innerText=formatNumber(giagiam);
    document.getElementById("conlai").innerText=formatNumber(conlai);

    const tentaikhoan=getParam("tentaikhoan"), sotaikhoan=getParam("sotaikhoan"), nganhang=getParam("nganhang");
    document.getElementById("tentaikhoan").innerText=tentaikhoan;
    document.getElementById("sotaikhoan").innerText=sotaikhoan;
    document.getElementById("nganhang").innerText=nganhang;
    const map=getParam("maphieu"), room=getParam("maso"), kyth=getParam("kythanhtoan");
    const noidung=`${map} ${room} TT BILL TH ${kyth}`;
    document.getElementById("noidungck").innerText=noidung;
    document.getElementById("vietqr").src=`https://img.vietqr.io/image/${nganhang.toLowerCase()}-${sotaikhoan}-compact2.png?amount=${conlai}&addInfo=${encodeURIComponent(noidung)}&accountName=${encodeURIComponent(tentaikhoan)}`;
  </script>
</body>
</html>
